version: 2
jobs:
  build:
    working_directory: ~/
    machine: true
    steps:
      - checkout
      - run:
          name: build image 
          command: docker build -t ddns-test:tmp ./dockerfile
      - run:
          name: save image
          command: docker save ddns-test:tmp > ddns-test.tar
      - save_cache:
          key: image-{{ epoch }}
          paths:
            - ~/

  deploy:
    working_directory: ~/
    machine: true
    steps:
      - restore_cache:
          keys:
            - image
      - run:
          name: restore image
          command: docker load < ddns-test.tar
      - run:
          name: login arc repo
          command: docker login $ACR_LOGIN_SERVER --username $ACR_LOGIN_ID --password $ACR_LOGIN_PASS
      - run:
          name: get date for image tag
          command: |
            echo 'export VERSION=`date +"%Y%m%d%H%M%S"`' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: set tag as current version 
          command: docker tag ddns-test:tmp $ACR_LOGIN_SERVER/ddns-test:$VERSION
      - run:
          name: push image as current version
          command: docker push $ACR_LOGIN_SERVER/ddns-test:$VERSION
      - run:
          name: set tag as latest version
          command: docker tag ddns-test:tmp $ACR_LOGIN_SERVER/ddns-test:latest
      - run:
          name: push image as latest version
          command: docker push $ACR_LOGIN_SERVER/ddns-test:latest

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build